generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Server {
  id          String   @id @default(cuid())
  name        String
  apiUrl      String   @map("api_key") // Storing PRC Server Key here
  bannerUrl   String?  // Custom banner image URL
  customName  String?  // Display name override
  onDutyRoleId String? // Discord Role ID to give when on duty
  discordGuildId String? // Discord Guild ID for this server
  autoSyncRoles Boolean @default(false) // Auto-sync roles every 10s
  suspendedRoleId  String? // Discord Role ID - blocks mod panel access
  terminatedRoleId String? // Discord Role ID - triggers account deletion
  staffRoleId      String? // General staff Discord role (viewer access)
  permLogChannelId String? // Discord Channel ID for Permission Logs
  staffRequestChannelId String? // Discord Channel ID for Staff Requests
  raidAlertChannelId    String? // Discord Channel ID for Raid Alerts
  commandLogChannelId   String? // Discord Channel ID for Command Logs
  createdAt   DateTime @default(now())
  
  logs            Log[]
  punishments     Punishment[]
  shifts          Shift[]
  roles           Role[]
  members         Member[]
  leaveOfAbsences LeaveOfAbsence[]
  automations     Automation[]
  botQueue        BotQueue[]
  forms           Form[]
}

model Log {
  id        String   @id @default(cuid())
  server    Server   @relation(fields: [serverId], references: [id], onDelete: Cascade)
  serverId  String
  type      String   // join, kill, command
  
  // Player info (for join/command logs)
  playerName  String?
  playerId    String?
  
  // Kill log specific
  killerName  String?
  killerId    String?
  victimName  String?
  victimId    String?
  
  // Command log specific
  command     String?
  arguments   String?
  
  // Join log specific
  isJoin      Boolean @default(true) // true = join, false = leave
  
  // PRC timestamp (Unix)
  prcTimestamp Int?
  
  createdAt DateTime @default(now())
  
  @@index([serverId, createdAt])
  @@index([serverId, type, prcTimestamp]) // Optimizes duplicate checking
  @@index([playerId])
  @@index([killerId])
  @@index([victimId])
}

model Punishment {
  id          String   @id @default(cuid())
  server      Server   @relation(fields: [serverId], references: [id], onDelete: Cascade)
  serverId    String
  userId      String
  moderatorId String
  type        String   // Warn, Kick, Ban, Ban Bolo
  reason      String?
  resolved    Boolean  @default(false)
  createdAt   DateTime @default(now())

  @@index([serverId, userId, createdAt]) // Optimizes profile loading
}

model Shift {
  id        String    @id @default(cuid())
  userId    String
  startTime DateTime  @default(now())
  endTime   DateTime?
  duration  Int?      // In seconds
  
  server    Server   @relation(fields: [serverId], references: [id], onDelete: Cascade)
  serverId  String

  @@index([userId, startTime])
  @@index([serverId, startTime])
}

model Config {
  key   String @id
  value String // JSON string
}

model Role {
  id           String   @id @default(cuid())
  name         String
  color        String   @default("#ffffff")
  quotaMinutes Int      @default(0) // Weekly
  isDefault    Boolean  @default(false)
  discordRoleId String? // Discord Role ID to sync
  
  // Permissions
  canShift            Boolean @default(true)
  canViewOtherShifts  Boolean @default(true)
  canViewLogs         Boolean @default(true)
  canViewPunishments  Boolean @default(true)
  canIssueWarnings    Boolean @default(true)
  canKick             Boolean @default(true)
  canBan              Boolean @default(true)
  canBanBolo          Boolean @default(true)
  canUseToolbox       Boolean @default(true)
  canManageBolos      Boolean @default(true)
  canRequestLoa       Boolean @default(true)
  canViewQuota        Boolean @default(true)
  canUseAdminCommands Boolean @default(false)
  
  server       Server   @relation(fields: [serverId], references: [id], onDelete: Cascade)
  serverId     String
  
  members      Member[]
}

model Member {
  id        String   @id @default(cuid())
  userId    String   // Clerk user ID
  discordId String?  // Discord user ID for bot lookups
  isAdmin   Boolean  @default(false) // Can access admin panel
  
  server    Server   @relation(fields: [serverId], references: [id], onDelete: Cascade)
  serverId  String
  
  role      Role?    @relation(fields: [roleId], references: [id])
  roleId    String?
  
  createdAt DateTime @default(now())

  @@unique([userId, serverId])
  @@index([userId])
  @@index([discordId, serverId])
}

model LeaveOfAbsence {
  id          String    @id @default(cuid())
  userId      String
  serverId    String
  server      Server    @relation(fields: [serverId], references: [id], onDelete: Cascade)
  startDate   DateTime
  endDate     DateTime
  reason      String
  status      String    @default("pending") // pending, approved, declined
  reviewedBy  String?   // Admin who reviewed
  reviewedAt  DateTime?
  createdAt   DateTime  @default(now())
  
  @@index([serverId, status])
  @@index([userId])
}

model Automation {
  id        String   @id @default(cuid())
  name      String
  enabled   Boolean  @default(true)
  trigger   String   // e.g., "PLAYER_JOIN", "SHIFT_START"
  conditions String  // JSON string
  actions    String  // JSON string
  lastRunAt  DateTime?
  
  server    Server    @relation(fields: [serverId], references: [id], onDelete: Cascade)
  serverId  String
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([serverId])
}

model BotQueue {
  id        String   @id @default(cuid())
  server    Server   @relation(fields: [serverId], references: [id], onDelete: Cascade)
  serverId  String
  
  type      String   // MESSAGE, DM
  targetId  String   // Channel ID or User ID
  content   String
  
  status    String   @default("PENDING") // PENDING, SENT, FAILED
  error     String?
  
  createdAt   DateTime @default(now())
  processedAt DateTime?

  @@index([serverId, status])
}

// SECURITY & API MANAGEMENT
model ApiKey {
  id          String   @id @default(cuid())
  name        String   // Name of the tool/integration
  key         String   @unique // Secret key
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now())
  lastUsed    DateTime?

  // Rate Limiting
  rateLimit   Int      @default(5)   // Seconds between requests
  dailyLimit  Int      @default(500) // Max requests per 24h
  usageCount  Int      @default(0)   // Requests today
  resetAt     DateTime @default(now()) // When usageCount resets
}

model BannedIp {
  id        String   @id @default(cuid())
  ip        String   @unique
  reason    String?
  createdAt DateTime @default(now())
}

model SecurityLog {
  id        String   @id @default(cuid())
  event     String   // e.g. "IP_BANNED", "BLOCKED_REQUEST", "API_KEY_USED"
  ip        String
  userId    String?
  details   String?
  createdAt DateTime @default(now())

  @@index([ip])
  @@index([createdAt])
}

// Command queue for cross-server synchronization (e.g., bans)
// Commands are queued when target server is empty, then executed when populated
model CommandQueue {
  id          String   @id @default(cuid())
  serverId    String   // Target server to execute command on
  command     String   // The PRC command to execute (e.g., ":ban username reason")
  priority    Int      @default(0) // Higher = processed first
  status      String   @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  error       String?
  
  // Source info for tracking
  sourceServerId String?  // Server where the original action was taken
  relatedUserId  String?  // Roblox user ID this command affects
  
  createdAt   DateTime @default(now())
  processedAt DateTime?

  @@index([serverId, status])
  @@index([status, createdAt])
}

// FORMS FEATURE
model Form {
  id          String   @id @default(cuid())
  serverId    String
  server      Server   @relation(fields: [serverId], references: [id], onDelete: Cascade)
  
  // Basic Info
  title           String
  description     String?
  bannerUrl       String?
  
  // Settings
  status          String    @default("draft")    // draft, published, closed
  requiresAuth    Boolean   @default(false)      // Require POW account to submit
  isAnonymous     Boolean   @default(false)      // Hide respondent identity from admins
  allowMultiple   Boolean   @default(true)       // Allow multiple submissions per person
  maxResponses    Int?                           // Total response limit (null = unlimited)
  expiresAt       DateTime?                      // Form expiration date
  
  // Discord Notifications
  notifyChannelId String?                        // Discord channel for notifications
  
  // Sharing
  publicShareId   String    @unique @default(cuid()) // For public share links
  editorShareId   String    @unique @default(cuid()) // For editor access links
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  createdBy   String                             // Clerk user ID of creator
  
  sections      FormSection[]
  responses     FormResponse[]
  editorAccess  FormEditorAccess[]
  
  @@index([serverId])
  @@index([publicShareId])
  @@index([editorShareId])
}

model FormSection {
  id          String   @id @default(cuid())
  formId      String
  form        Form     @relation(fields: [formId], references: [id], onDelete: Cascade)
  
  title       String
  description String?
  order       Int      @default(0)
  
  questions   FormQuestion[]
  
  @@index([formId])
}

model FormQuestion {
  id          String      @id @default(cuid())
  sectionId   String
  section     FormSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  
  type        String                          // short_text, long_text, multiple_choice, checkbox, 
                                              // dropdown, scale, date, time, file_upload
  label       String
  description String?
  required    Boolean   @default(false)
  order       Int       @default(0)
  
  // Options (JSON) - for choice-based questions
  // e.g., { "options": ["Yes", "No"], "min": 1, "max": 10, "allowedTypes": ["image/*"] }
  config      String    @default("{}")
  
  // Conditional Logic (JSON)
  // e.g., { "showIf": { "questionId": "xxx", "operator": "equals", "value": "Yes" } }
  conditions  String    @default("{}")
  
  answers     FormAnswer[]
  
  @@index([sectionId])
}

model FormResponse {
  id          String   @id @default(cuid())
  formId      String
  form        Form     @relation(fields: [formId], references: [id], onDelete: Cascade)
  
  respondentId    String?                      // Clerk user ID (null if anonymous/no-auth)
  respondentEmail String?                      // Optional email for non-auth forms
  
  submittedAt DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt
  status      String   @default("completed")    // draft, completed
  
  answers     FormAnswer[]
  
  @@index([formId])
  @@index([respondentId])
}

model FormAnswer {
  id          String       @id @default(cuid())
  responseId  String
  response    FormResponse @relation(fields: [responseId], references: [id], onDelete: Cascade)
  questionId  String
  question    FormQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  
  // Store answer as JSON to handle all types uniformly
  // e.g., "Hello" for text, ["Option A", "Option B"] for checkbox, { "fileUrl": "...", "fileName": "..." } for uploads
  value       String
  
  @@index([responseId])
  @@index([questionId])
  @@unique([responseId, questionId]) // Ensure one answer per question per response
}

model FormEditorAccess {
  id        String  @id @default(cuid())
  formId    String
  form      Form    @relation(fields: [formId], references: [id], onDelete: Cascade)
  userId    String                              // Clerk user ID with editor access
  
  grantedAt DateTime @default(now())
  
  @@unique([formId, userId])
  @@index([userId])
}

